name: Red Hat
on:
  pull_request:
  push:
    branches: [ main ]
jobs:
  centos_stream:
    name:  ${{ matrix.dist }}-${{ matrix.compiler}}-${{ matrix.build_type }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dist:
          - stream9
          - stream10
        build_type:
          - Debug
          - Release
        compiler:
          - gcc
          - clang
    container: quay.io/centos/centos:${{ matrix.dist }}
    steps:
      - name: Install development tools
        run: |
          dnf install -y epel-release
          /usr/bin/crb enable
          dnf install -y \
              clang \
              gcc \
              g++ \
              gfortran \
              cmake \
              make \
              cfitsio-devel \
              file \
              git

      - name: checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-tags: true
          fetch-depth: 0

      - name: build
        run: |
          mkdir build
          cd build
          cmake .. \
              -DCMAKE_INSTALL_PREFIX=/tmp/hstcal \
              -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
              -DCMAKE_C_COMPILER=${{ matrix.compiler }} \
              -DCMAKE_C_FLAGS="-Wno-incompatible-pointer-types"
          make -j$(nproc)
          make install

      - name: Dump file types
        run: |
          find /tmp/hstcal -type f | sort | xargs file

      - name: Dump DISTINFO
        run: |
          cd build
          cat DISTINFO

      - name: Dump --gitinfo header
        run: |
          cd build
          cat -n version.h

      - name: Dump --gitinfo from executable
        run: |
          export PATH=/tmp/hstcal/bin:$PATH
          calacs.e --gitinfo

      - name: Check common CLI arguments
        run: |
          export PATH=/tmp/hstcal/bin:$PATH
          program=(
            calacs.e
            calwf3.e
            cs0.e
          )
          option=(
            --help
            --version
            --gitinfo
          )
          for x in "${program[@]}"; do
            echo "TEST $x:"
            for opt in "${option[@]}"; do
              .ci/bin/check_exec "$opt" -- "$x"
            done
            echo
          done
