language: c

env:
  global:
    # Set defaults to avoid repeating in most cases
    - EXE_PREFIX="/tmp/miniconda3"
    - PYTHON_VERSION=3.7
    - WAF_ARGS_CONFIGURE="-v"
    - WAF_ARGS_BUILD="-v"
    - WAF_ARGS_INSTALL="-v"

arch:
  - amd64
  - ppc64le
  - s390x
  - arm64

jobs:
  fast_finish: true

  include:
  - os: linux
    compiler: gcc
    dist: xenial

before_install:
  - mkdir $EXE_PREFIX $EXE_PREFIX/bin
  - export PATH=$EXE_PREFIX/bin:$PATH
  - sudo apt-get -y update
  - sudo apt-get -y install gfortran
  - sudo apt-get -y install libcfitsio-dev
  - sudo apt-get -y install curl
  - sudo apt-get -y install pkg-config

install:
  - ./waf configure --prefix=$EXE_PREFIX $WAF_ARGS_CONFIGURE
  - ./waf build $WAF_ARGS_BUILD
  - ./waf install $WAF_ARGS_INSTALL

script:
  - calacs.e --version
  - calwf3.e --version
  - cs0.e --version

# Ideally, we want to smoke test all the generated executables, but right
# now, not all of them have --version and this crashes. When this is fixed,
# Remove the hardcoded commands above and use this.
#
#  - .ci/bin/check_exec --version -- $(find $CONDA_PREFIX/bin -name '*.e')
